<!DOCTYPE html>
<html lang="ja">
  <head>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <script>
      miro.onReady(() => {
        miro.initialize({
          extensionPoints: {
            bottomBar: {
              title: 'The button title',
              svgIcon: '<circle cx="12" cy="12" r="9" fill="blue" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
              onClick: async () => {
                let selectedStickers = await miro.board.selection.get({ type: 'sticker' });

                console.log(selectedStickers);

                const viewport = await miro.board.viewport.get();
                const centeredX = viewport.x + viewport.width / 2;
                const centeredY = viewport.y + viewport.height / 2;

                const plannedSTicker = { type: 'sticker', text: '', scale: 1.5, x: centeredX, y: centeredY };
                let plannedTotal = 0;

                try {
                  for (sticker of selectedStickers) {
                    const tag = sticker.tags.find((t) => t.title.startsWith('予定：'));
                    if (tag) {
                      console.log(tag.title);
                      plannedTotal += parseFloat(tag.title.replace('予定：', '').replace('h', ''));
                    }
                  }

                  plannedSTicker.text = `予定時間：${plannedTotal}h`;
                } catch (e) {
                  plannedSTicker.text = `予定時間：Error`;
                }

                miro.board.widgets.create(plannedSTicker);
              },
            },
          },
        });
      });
    </script>
  </head>
</html>
